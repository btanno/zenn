---
title: "OutputDebugStringã®æ–‡å­—åˆ—ã‚’å–å¾—ã™ã‚‹"
emoji: "ðŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["windows"]
published: true
---

æœ¬æ–‡ã®ã‚½ãƒ¼ã‚¹ã¯Rustã§windows-rs 0.58ã‚’ä½¿ã£ã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚

# æ¦‚è¦

`OutputDebugString`ã¯ãƒ™ã‚¯ãƒˆãƒ«åŒ–ä¾‹å¤–ã‚’ä½¿ã£ã¦æ–‡å­—åˆ—ã‚’å‡ºåŠ›ã—ã¦ã„ã¾ã™ã€‚

ãƒ™ã‚¯ãƒˆãƒ«åŒ–ä¾‹å¤–ã«ã¯`AddVectoredExceptionHandler`ã‚’ä½¿ã£ã¦ãƒãƒ³ãƒ‰ãƒ©ã‚’ç™»éŒ²ã§ãã€ãƒãƒ³ãƒ‰ãƒ©ã«æ¸¡ã•ã‚Œã‚‹å¼•æ•°ã‹ã‚‰æ–‡å­—åˆ—ã‚’å–å¾—ã§ãã¾ã™ã€‚

ã¡ãªã¿ã«Direct3D12ã®ãƒ‡ãƒãƒƒã‚°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‡ºåŠ›ã‚‚å–å¾—ã§ãã¾ã™ã€‚

# æ‰‹é †

ã“ã“ã§ã¯`OutputDebugString`ã®æ–‡å­—åˆ—ã‚’å–å¾—ã—ã¦æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«æµã™ã“ã¨ã«ã—ã¾ã™ã€‚

1. `AddVectoredExceptionHandler`ã§ãƒãƒ³ãƒ‰ãƒ©ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

```rust
unsafe extern "system" fn handler_proc(pointers: *mut EXCEPTION_POINTERS) -> i32 {
    // ã“ã“ã«å‡¦ç†ã‚’æ›¸ã„ã¦ã„ã
}

fn main() {
    unsafe {
        // ãƒãƒ³ãƒ‰ãƒ©ã®ç™»éŒ²
        AddVectoredExceptionHandler(0, Some(handler_proc));
        // å‡ºåŠ›ã—ã¦ã¿ã‚‹
        OutputDebugStringA(windows::core::s!("output A"));
        OutputDebugStringW(windows::core::w!("output W"));
    }
}
```

2. ãƒãƒ³ãƒ‰ãƒ©ã®å¼•æ•°`EXCEPTION_POINTERS`ã®`ExceptionRecord`ã«ã‚ã‚‹`ExceptionCode`ã«`DBG_PRINTEXCEPTION_C`ã¾ãŸã¯`DBG_PRINTEXCEPTION_WIDE_C`ãŒå…¥ã£ã¦ã‚‹ã‹ã©ã†ã‹ã‚’èª¿ã¹ã¾ã™ã€‚

```rust
unsafe extern "system" fn handler_proc(pointers: *mut EXCEPTION_POINTERS) -> i32 {
    // ãƒã‚¤ãƒ³ã‚¿ãªã®ã§ä¸€å¿œãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹
    // ã‚ã¨ãƒ‘ãƒ‹ãƒƒã‚¯ã«ã—ãŸããªã„
    let Some(pointers) = pointers.as_ref() else {
        return EXCEPTION_CONTINUE_SEARCH;
    };
    let Some(record) = pointers.ExceptionRecord.as_ref() else {
        return EXCEPTION_CONTINUE_SEARCH;
    };
    // 2.ã®å‡¦ç†ã¯ã“ã“ã‹ã‚‰
    match record.ExceptionCode {
        DBG_PRINTEXCEPTION_C => {
            // OutputDebugStringAã®å ´åˆã¯ã“ã“ã«ãã‚‹
            EXCEPTION_CONTINUE_EXECUTION
        }
        DBG_PRINTEXCEPTION_WIDE_C => {
            // OutputDebugStringWã®å ´åˆã¯ã“ã“ã«ãã‚‹
            EXCEPTION_CONTINUE_EXECUTION
        }
        _ => EXCEPTION_CONTINUE_SEARCH
    }
}
```

3. `ExceptionRecord`ã«ã‚ã‚‹`ExceptionInformation[0]`ã«æ–‡å­—åˆ—ã®é•·ã•ã€`ExceptionInformation[1]`ã«æ–‡å­—åˆ—ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ã“ã‚Œã‚‰ã‹ã‚‰æ–‡å­—åˆ—ã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã®æ™‚`ExceptionInformation[0]`ã«å…¥ã£ã¦ã„ã‚‹æ–‡å­—åˆ—ã®é•·ã•ã¯0çµ‚ç«¯ã‚’å«ã¿`DBG_PRINTEXCEPTION_C`ã§ã¯ãƒã‚¤ãƒˆé•·ã€`DBG_PRINTEXCEPTION_WIDE_C`ã§ã¯æ–‡å­—æ•°ã¨ãªã£ã¦ã„ã¾ã™ã€‚
ãã—ã¦å–å¾—ã—ãŸæ–‡å­—åˆ—ã‚’æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«æµã›ã°OKã§ã™ã€‚

```rust
match record.ExceptionCode {
    DBG_PRINTEXCEPTION_C => {
        let len = record.ExceptionInformation[0];
        // ãƒžãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—åˆ—ãªã®ã§u8
        let data = std::slice::from_raw_parts(
            record.ExceptionInformation[1] as *const u8,
            len - 1 // 0çµ‚ç«¯ã®åˆ†ã‚’len - 1ã§åˆ‡ã£ã¦ã„ã‚‹
        );
        // æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«æµã™
        // ãƒžãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—åˆ—ãªã®ã§æœ¬æ¥ã¡ã‚ƒã‚“ã¨å¤‰æ›ã—ãªã„ã¨ã„ã‘ãªã„ãŒ
        // é¢å€’ãªã®ã§`std::str::from_utf8`ã§ãŠèŒ¶ã‚’æ¿ã™
        eprintln!(
            "DBG_PRINTEXCEPTION_C: {}: {:?}",
            record.ExceptionInformation[0],
            std::str::from_utf8(data)
        );
        EXCEPTION_CONTINUE_EXECUTION
    }
    DBG_PRINTEXCEPTION_WIDE_C => {
        let len = record.ExceptionInformation[0];
        // ãƒ¯ã‚¤ãƒ‰æ–‡å­—åˆ—ãªã®ã§u16
        let data = std::slice::from_raw_parts(
            record.ExceptionInformation[1] as *const u16,
            len - 1 // 0çµ‚ç«¯ã®åˆ†ã‚’len - 1ã§åˆ‡ã£ã¦ã„ã‚‹
        );
        // æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«æµã™
        eprintln!(
            "DBG_PRINTEXCEPTION_WIDE_C: {}: {:?}",
            record.ExceptionInformation[0],
            String::from_utf16(data)
        );
        EXCEPTION_CONTINUE_EXECUTION
    }
}
```

# æ³¨æ„ç‚¹

## ãƒ‡ãƒãƒƒã‚¬ãŒã‚ã‚‹å ´åˆ

VSCodeã®`cppvsdbg`ã®ã‚ˆã†ã«ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œã‚’ã™ã‚‹ã¨ãƒ‡ãƒãƒƒã‚¬ãŒå…¥ã‚‹å ´åˆã¯ã€`AddVectoredExceptionHandler`ã®æœ€åˆã®å¼•æ•°ã«0ä»¥å¤–ã‚’å…¥ã‚Œã¦ã‚‚ãƒ‡ãƒãƒƒã‚¬ã®ãƒãƒ³ãƒ‰ãƒ©ãŒå„ªå…ˆã•ã‚Œã¦ç™»éŒ²ã—ãŸãƒãƒ³ãƒ‰ãƒ©ã¯å‘¼ã³å‡ºã•ã‚Œãªã„ã‚ˆã†ã§ã™ã€‚

## `OutputDebugStringW`ã®å ´åˆ

`OutputDebugStringW`ã‚’å‘¼ã¶ã¨`DBG_PRINTEXCEPTION_WIDE_C`ãŒæŠ•ã’ã‚‰ã‚Œã¾ã™ãŒã€
ã©ã®ãƒãƒ³ãƒ‰ãƒ©ã‚‚`EXCEPTION_CONTINUE_EXECUTION`ã‚’è¿”ã•ãªã‹ã£ãŸå ´åˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦`DBG_PRINTEXCEPTION_C`ãŒæŠ•ã’ã‚‰ã‚Œã¾ã™ã€‚

ä¾‹ãˆã°`DEB_PRINTEXCEPTION_C`ã¨`DBG_PRINTEXCEPTION_WIDE_C`ã®ä¸¡æ–¹ã§æ–‡å­—åˆ—ã‚’å‡ºåŠ›ã™ã‚‹ã¨ã—ã¦ã€
ãƒãƒ³ãƒ‰ãƒ©ã§`DBG_PRINTEXCEPTION_WIDE_C`ã§æ–‡å­—åˆ—ã‚’å‡ºåŠ›ã—ã¦`EXCEPTION_CONTINUE_SEARCH`ã‚’è¿”ã—ãŸå¾Œã«å¾Œç¶šã®ãƒãƒ³ãƒ‰ãƒ©ãŒ`EXCEPTION_CONTINUE_EXECUTION`ã‚’è¿”ã•ãªã„ã¨
`DBG_PRINTEXCEPTION_C`ãŒæ¥ã¦äºŒé‡ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

# ã‚½ãƒ¼ã‚¹

```rust
use windows::Win32::{Foundation::*, System::Diagnostics::Debug::*};

unsafe extern "system" fn handler_proc(pointers: *mut EXCEPTION_POINTERS) -> i32 {
    let Some(pointers) = pointers.as_ref() else {
        return EXCEPTION_CONTINUE_SEARCH;
    };
    let Some(record) = pointers.ExceptionRecord.as_ref() else {
        return EXCEPTION_CONTINUE_SEARCH;
    };
    match record.ExceptionCode {
        DBG_PRINTEXCEPTION_C => {
            let len = record.ExceptionInformation[0];
            let data = std::slice::from_raw_parts(
                record.ExceptionInformation[1] as *const u8,
                len - 1
            );
            eprintln!(
                "DBG_PRINTEXCEPTION_C: {}: {:?}",
                record.ExceptionInformation[0],
                std::str::from_utf8(data)
            );
            EXCEPTION_CONTINUE_EXECUTION
        }
        DBG_PRINTEXCEPTION_WIDE_C => {
            let len = record.ExceptionInformation[0];
            let data = std::slice::from_raw_parts(
                record.ExceptionInformation[1] as *const u16,
                len - 1
            );
            eprintln!(
                "DBG_PRINTEXCEPTION_WIDE_C: {}: {:?}",
                record.ExceptionInformation[0],
                String::from_utf16(data)
            );
            EXCEPTION_CONTINUE_EXECUTION
        }
        _ => EXCEPTION_CONTINUE_SEARCH
    }
}

fn main() {
    unsafe {
        AddVectoredExceptionHandler(0, Some(handler_proc));
        OutputDebugStringA(windows::core::s!("output A"));
        OutputDebugStringW(windows::core::w!("output W"));
    }
}
```

```toml:Cargo.toml
[dependencies.windows]
version = "0.58"
features = [
    "Win32_Foundation",
    "Win32_System_Kernel",
    "Win32_System_Diagnostics_Debug",
]
```